# File: /.azure-ci/steps/test-formulae.yml

steps:

  - bash: |
      declare -a FAILING_FORMULAE

      for formula in Formula/* ; do

        formula=$(basename $formula ".rb")

        echo ""
        echo "Installing $formula"

        if brew install $formula 2>/dev/null ; then

          echo ""
          brew test $formula && brew linkage --test $formula

          if [ $? -eq 1 ]; then
            echo ""
            echo "ğŸ’¥ $formula test failed"
            FAILING_FORMULAE+=($formula)
          fi

        else

          echo "$formula is --HEAD only, skipping tests."

        fi

      done

      if [ ${#FAILING_FORMULAE[@]} -eq 0 ]; then

        echo "All formulae passed the test, there's nothing to worry about. ğŸ‰"
        echo "We'll try again next time... ğŸ’ª"

      else

        echo ""
        echo "ğŸ’¥ The following formulae failed:"

        for f in ${FAILING_FORMULAE[@]}; do
          echo "  - $f"
        done

        echo ""
        echo "ğŸš§ A new PR will be created to bump the revision and rebuild the formulae. ğŸ—"

        echo "##vso[task.setvariable variable=failing_formulae;isOutput=true]$FAILING_FORMULAE"

      fi
    displayName: Step - Test Formulae
    name: test_formulae


