# File: /.azure-ci/steps/test-formulae-from-source.yml

steps:

  - bash: |
      FAILING_FORMULAE=""

      for formula in Formula/* ; do

        formula=$(basename $formula ".rb")

        echo ""
        echo "ğŸ—ï¸ Installing $formula"

        if brew install $formula 2>/dev/null ; then

          brew install --build-from-source $formula && brew linkage --test $formula

          if [ $? -eq 1 ]; then
            echo ""
            echo "ğŸ’¥ $formula test failed"
            FAILING_FORMULAE+=" $formula"
          else
            echo ""
            echo "âœ… $formula test succeeded"
          fi

        else

          echo "$formula is --HEAD only, skipping tests."

        fi

      done

      if [[ -z $FAILING_FORMULAE ]]; then

        echo ""
        echo "All formulae have passed the test, there's nothing to worry about. ğŸ‰"
        echo "We'll try again next time... ğŸ’ª"

      else

        echo ""
        echo "ğŸ’¥ The following formulae failed:"

        for f in $FAILING_FORMULAE; do
          echo "  - $f"
        done

        echo ""
        echo "ğŸš§ A new PR will be created to bump the revision and rebuild the formulae. ğŸ—"

        echo "##vso[task.setvariable variable=failing_formulae;isOutput=true]$FAILING_FORMULAE"

      fi
    displayName: Step - Test Formulae
    name: test_formulae


